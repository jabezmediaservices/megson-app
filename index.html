<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megson Plastering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --megson-blue: #003366; --megson-orange: #f39c12; }
        .bg-megson-blue { background-color: var(--megson-blue); }
        .text-megson-blue { color: var(--megson-blue); }
        .filter-pill.active { background-color: var(--megson-blue); color: white; border-color: var(--megson-blue); }
        #phone-modal, #edit-modal { background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .tab-btn.active { color: var(--megson-orange); border-top: 4px solid var(--megson-orange); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-28">

    <div id="edit-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl space-y-4">
            <h2 class="text-xl font-black uppercase italic text-megson-blue">Edit Project</h2>
            <div class="grid grid-cols-1 gap-3">
                <input type="text" id="edit-client" class="border p-4 rounded-2xl w-full" placeholder="Client Name">
                <input type="tel" id="edit-phone" class="border p-4 rounded-2xl w-full" placeholder="Phone">
                <div class="bg-gray-50 p-3 rounded-xl border border-blue-100">
                    <label class="text-[9px] font-black uppercase">Quote Value (¬£)</label>
                    <input type="number" id="edit-value" class="w-full bg-transparent text-lg font-bold" placeholder="0.00">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-gray-50 p-2 rounded-xl">
                        <label class="text-[9px] font-bold uppercase">Start Date</label>
                        <input type="date" id="edit-start" class="w-full bg-transparent text-sm">
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl">
                        <label class="text-[9px] font-bold uppercase">End Date</label>
                        <input type="date" id="edit-end" class="w-full bg-transparent text-sm">
                    </div>
                </div>
                <textarea id="edit-notes" class="border p-4 rounded-2xl w-full h-24 text-sm" placeholder="Scope of work..."></textarea>
            </div>
            <div class="flex gap-2 pt-2">
                <button onclick="saveEdit()" class="flex-1 bg-megson-blue text-white p-4 rounded-2xl font-black uppercase">Save Changes</button>
                <button onclick="closeModal('edit-modal')" class="flex-1 bg-gray-200 text-gray-600 p-4 rounded-2xl font-black uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <div id="app-content">
        <header class="bg-megson-blue text-white p-4 shadow-lg sticky top-0 z-40 flex justify-between items-center h-20">
            <div class="flex flex-col">
                <span class="font-black text-xl tracking-tighter uppercase italic leading-none">Megson Plastering</span>
                <span class="text-[10px] font-bold text-orange-400">07955 315849</span>
            </div>
            <button onclick="showSection('settings')" class="text-2xl bg-white/10 p-2 rounded-xl">‚òÅÔ∏è</button>
        </header>

        <section id="sec-jobs" class="p-4 space-y-4">
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="setFilter('All')" class="filter-pill active px-5 py-2 rounded-full border bg-white text-[10px] font-black" data-status="All">ALL</button>
                <button onclick="setFilter('Pending')" class="filter-pill px-5 py-2 rounded-full border bg-white text-[10px] font-black text-gray-400" data-status="Pending">PENDING</button>
                <button onclick="setFilter('Active')" class="filter-pill px-5 py-2 rounded-full border bg-white text-[10px] font-black text-blue-500" data-status="Active">ACTIVE</button>
                <button onclick="setFilter('Invoiced')" class="filter-pill px-5 py-2 rounded-full border bg-white text-[10px] font-black text-orange-500" data-status="Invoiced">INVOICED</button>
                <button onclick="setFilter('Completed')" class="filter-pill px-5 py-2 rounded-full border bg-white text-[10px] font-black text-green-500" data-status="Completed">PAID</button>
            </div>
            <div id="job-list-container" class="space-y-4"></div>
        </section>

        <section id="sec-pro-calc" class="p-4 hidden pb-10">
            <div class="bg-white p-6 rounded-3xl shadow-md border-t-8 border-megson-blue">
                <h2 class="text-xl font-black text-megson-blue uppercase italic mb-1">Material Calc</h2>
                <div class="bg-orange-50 p-4 rounded-2xl mt-4 mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-black text-orange-600 uppercase">Buffer: <span id="buffer-val">50</span>%</span>
                    </div>
                    <input type="range" id="buffer-slider" min="0" max="100" value="50" class="w-full h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer" oninput="runProCalc()">
                </div>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="text-center font-bold"><label class="text-[9px] text-gray-400 block mb-1">L (m)</label><input type="number" id="pro-L" class="w-full border p-4 rounded-2xl text-center" oninput="runProCalc()"></div>
                    <div class="text-center font-bold"><label class="text-[9px] text-gray-400 block mb-1">W (m)</label><input type="number" id="pro-W" class="w-full border p-4 rounded-2xl text-center" oninput="runProCalc()"></div>
                    <div class="text-center font-bold"><label class="text-[9px] text-gray-400 block mb-1">H (m)</label><input type="number" id="pro-H" class="w-full border p-4 rounded-2xl text-center" oninput="runProCalc()"></div>
                </div>
                <div class="flex items-center justify-between bg-gray-50 p-5 rounded-2xl mb-6 font-black uppercase text-xs italic text-gray-500">
                    <span>Include Ceiling?</span>
                    <input type="checkbox" id="pro-ceiling" onchange="runProCalc()" class="w-8 h-8 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-6 rounded-3xl text-center border-b-4 border-blue-200">
                        <span class="text-[10px] uppercase font-black text-blue-400">Boards</span>
                        <div id="res-boards" class="text-4xl font-black text-megson-blue">0</div>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-3xl text-center border-b-4 border-orange-200">
                        <span class="text-[10px] uppercase font-black text-orange-400">Multi Bags</span>
                        <div id="res-multi" class="text-4xl font-black text-orange-600">0</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-add-job" class="p-4 hidden pb-24">
            <div class="bg-white p-6 rounded-3xl shadow-md border-t-8 border-megson-blue space-y-3">
                <input type="text" id="client-name" placeholder="Client Name" class="w-full border p-4 rounded-2xl">
                <input type="tel" id="client-phone" placeholder="Phone Number" class="w-full border p-4 rounded-2xl">
                <input type="number" id="client-value" placeholder="Quote Amount (¬£)" class="w-full border p-4 rounded-2xl">
                <button onclick="saveJob()" class="w-full bg-megson-blue text-white p-5 rounded-2xl font-black uppercase tracking-widest mt-4">Create Job</button>
            </div>
        </section>

        <section id="sec-settings" class="p-4 hidden">
            <div class="bg-white p-6 rounded-3xl shadow-md space-y-4">
                <h2 class="text-xl font-black text-megson-blue uppercase italic">Finance Overview</h2>
                <div class="bg-green-50 p-5 rounded-2xl border border-green-100">
                    <span class="text-[10px] font-black text-green-600 uppercase">Total Paid Earnings</span>
                    <div id="total-earnings" class="text-3xl font-black text-green-700">¬£0.00</div>
                </div>
                <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100">
                    <span class="text-[10px] font-black text-orange-600 uppercase">Pending Invoices</span>
                    <div id="pending-earnings" class="text-3xl font-black text-orange-700">¬£0.00</div>
                </div>
                <hr class="my-6">
                <button onclick="exportData()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black uppercase">üíæ Export Backup</button>
                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                <button onclick="document.getElementById('import-file').click()" class="w-full bg-gray-100 text-gray-600 p-5 rounded-2xl font-black uppercase border border-gray-200">‚òÅÔ∏è Restore Backup</button>
            </div>
        </section>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-4 z-40 shadow-2xl h-24">
            <button onclick="showSection('jobs')" class="tab-btn active flex flex-col items-center text-[10px] font-black"><span class="text-3xl">üìÅ</span>Jobs</button>
            <button onclick="showSection('pro-calc')" class="tab-btn flex flex-col items-center text-[10px] font-black text-gray-400"><span class="text-3xl">üßÆ</span>Calc</button>
            <button onclick="showSection('add-job')" class="tab-btn flex flex-col items-center text-[10px] font-black text-gray-400"><span class="text-3xl">‚ûï</span>Add</button>
        </nav>
    </div>

    <script>
        let appState = { jobs: [], filter: 'All', currentEditId: null };
        
        function init() {
            const saved = localStorage.getItem('megson_data_v3');
            if(saved) appState = JSON.parse(saved);
            renderJobs();
            calcFinances();
        }

        function showSection(id) {
            ['jobs', 'add-job', 'settings', 'pro-calc'].forEach(s => document.getElementById('sec-' + s).classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-megson-blue'));
            if(id === 'settings') calcFinances();
        }

        function setFilter(status) {
            appState.filter = status;
            document.querySelectorAll('.filter-pill').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            renderJobs();
        }

        function editJob(id) {
            const job = appState.jobs.find(j => j.id === id);
            appState.currentEditId = id;
            document.getElementById('edit-client').value = job.client;
            document.getElementById('edit-phone').value = job.phone || '';
            document.getElementById('edit-value').value = job.value || '';
            document.getElementById('edit-start').value = job.dateFrom || '';
            document.getElementById('edit-end').value = job.dateTo || '';
            document.getElementById('edit-notes').value = job.notes || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function saveEdit() {
            const job = appState.jobs.find(j => j.id === appState.currentEditId);
            job.client = document.getElementById('edit-client').value;
            job.phone = document.getElementById('edit-phone').value;
            job.value = document.getElementById('edit-value').value;
            job.dateFrom = document.getElementById('edit-start').value;
            job.dateTo = document.getElementById('edit-end').value;
            job.notes = document.getElementById('edit-notes').value;
            saveAndRefresh();
            closeModal('edit-modal');
        }

        function toggleStatus(id) {
            const job = appState.jobs.find(j => j.id === id);
            const cycle = ["Pending", "Active", "Invoiced", "Completed"];
            let idx = cycle.indexOf(job.status);
            job.status = cycle[(idx + 1) % cycle.length];
            saveAndRefresh();
        }

        function renderJobs() {
            const container = document.getElementById('job-list-container');
            const filtered = appState.jobs.filter(j => appState.filter === 'All' || j.status === appState.filter);
            const statusStyle = { 
                "Pending": "border-gray-300 text-gray-400", 
                "Active": "border-blue-500 text-blue-500", 
                "Invoiced": "border-orange-500 text-orange-500", 
                "Completed": "border-green-500 text-green-500" 
            };

            container.innerHTML = filtered.length ? filtered.map(job => `
                <div class="bg-white p-6 rounded-3xl shadow-sm border-l-[12px] ${statusStyle[job.status].split(' ')[0]}">
                    <div class="flex justify-between items-start mb-4">
                        <div onclick="editJob(${job.id})">
                            <h3 class="font-black text-gray-800 uppercase text-lg leading-tight">${job.client} ‚úèÔ∏è</h3>
                            <div class="text-[11px] font-black text-blue-900 mt-1 italic">¬£${job.value || '0.00'}</div>
                        </div>
                        <button onclick="toggleStatus(${job.id})" class="text-[9px] px-3 py-1 rounded-full font-black uppercase border-2 ${statusStyle[job.status]}">${job.status === 'Completed' ? 'PAID' : job.status}</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.location.href='tel:${job.phone}'" class="bg-gray-100 p-4 rounded-2xl text-[10px] font-black uppercase">üìû Contact</button>
                        <button onclick="downloadPDF(${job.id})" class="bg-megson-blue text-white p-4 rounded-2xl text-[10px] font-black uppercase">üìÑ PDF Quote</button>
                    </div>
                </div>`).join('') : '<p class="text-center py-20 text-gray-300 font-black uppercase tracking-widest text-xs">No Projects Found</p>';
        }

        function calcFinances() {
            const paid = appState.jobs.filter(j => j.status === 'Completed').reduce((sum, j) => sum + (parseFloat(j.value) || 0), 0);
            const pending = appState.jobs.filter(j => j.status === 'Invoiced').reduce((sum, j) => sum + (parseFloat(j.value) || 0), 0);
            document.getElementById('total-earnings').innerText = `¬£${paid.toFixed(2)}`;
            document.getElementById('pending-earnings').innerText = `¬£${pending.toFixed(2)}`;
        }

        function saveJob() {
            const job = { id: Date.now(), client: document.getElementById('client-name').value, phone: document.getElementById('client-phone').value, value: document.getElementById('client-value').value, status: "Pending", notes: "" };
            appState.jobs.push(job);
            saveAndRefresh();
            showSection('jobs');
            ['client-name', 'client-phone', 'client-value'].forEach(i => document.getElementById(i).value = "");
        }

        function runProCalc() {
            const buf = parseInt(document.getElementById('buffer-slider').value);
            document.getElementById('buffer-val').innerText = buf;
            const L = parseFloat(document.getElementById('pro-L').value) || 0, W = parseFloat(document.getElementById('pro-W').value) || 0, H = parseFloat(document.getElementById('pro-H').value) || 0;
            const area = (2 * (L + W) * H) + (document.getElementById('pro-ceiling').checked ? (L * W) : 0);
            const multiplier = 1 + (buf / 100);
            document.getElementById('res-boards').innerText = Math.ceil((area / 2.88) * multiplier);
            document.getElementById('res-multi').innerText = Math.ceil((area / 10) * multiplier);
        }

        async function downloadPDF(jobId) {
            const job = appState.jobs.find(j => j.id === jobId);
            const doc = new jspdf.jsPDF();
            doc.setFontSize(22).setTextColor(0, 51, 102).text("MEGSON PLASTERING", 20, 25);
            doc.setFontSize(10).setTextColor(100).text(["Paul Megson", "07955 315849", "paul.megson@hotmail.com"], 20, 35);
            doc.setDrawColor(243, 156, 18).line(20, 50, 190, 50);
            doc.setFontSize(14).setTextColor(0).text(`QUOTE FOR: ${job.client.toUpperCase()}`, 20, 65);
            doc.setFontSize(11).text(`Project Total: ¬£${job.value || '0.00'}`, 20, 75);
            doc.setFontSize(10).text(`Scope: ${job.notes || 'As discussed on site.'}`, 20, 85);
            doc.save(`Megson_Quote_${job.client}.pdf`);
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveAndRefresh() { localStorage.setItem('megson_data_v3', JSON.stringify(appState)); renderJobs(); }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `megson_backup.json`); dl.click();
        }
        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => { appState = JSON.parse(e.target.result); saveAndRefresh(); alert("Success!"); };
            reader.readAsText(input.files[0]);
        }
        init();
    </script>
</body>
</html>